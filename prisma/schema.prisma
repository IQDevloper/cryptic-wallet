generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String        @id @default(cuid())
  email                  String        @unique
  name                   String
  password               String
  isActive               Boolean       @default(true)
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  deletedAt              DateTime?
  emailVerificationToken String?
  emailVerified          Boolean       @default(false)
  lastLogin              DateTime?
  passwordResetExpires   DateTime?
  passwordResetToken     String?
  role                   UserRole      @default(MERCHANT)
  auditLogs              AuditLog[]
  merchants              Merchant[]
  sessions               UserSession[]

  @@index([email])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("users")
}

model Merchant {
  id                String            @id @default(cuid())
  name              String
  apiKey            String            @unique
  apiKeyHash        String
  webhookUrl        String?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  userId            String?
  apiKeyCreatedAt   DateTime          @default(now())
  apiKeyLastUsed    DateTime?
  businessAddress   String?
  businessName      String?
  taxId             String?
  deletedAt         DateTime?
  // Removed unused fields: defaultCurrency, invoiceExpiry, isVerified, rateLimit, rateLimitWindow, webhookRetryCount, webhookSecret, webhookTimeout
  apiUsageStats     ApiUsageStats[]
  invoices          Invoice[]
  merchantSettings  MerchantSettings?
  user              User?             @relation(fields: [userId], references: [id])
  // wallets relation removed - using MerchantBalance with GlobalHDWallet system
  webhookDeliveries WebhookDelivery[]
  merchantBalances  MerchantBalance[]
  addresses         Address[]
  withdrawals       Withdrawal[]

  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([apiKeyLastUsed])
  @@index([userId])
  @@map("merchants")
}

model Network {
  id                 String        @id @default(cuid())
  code               String        @unique
  name               String
  tatumChainId       String        @unique
  blockConfirmations Int           @default(6)
  isTestnet          Boolean       @default(false)
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  deletedAt          DateTime?
  // Removed rarely used fields: averageBlockTime, explorerUrl, lastBlockChecked, lastStatusCheck, maxWithdrawAmount, minWithdrawAmount, networkStatus, rpcUrl, withdrawFee
  currencies         Currency[]

  @@index([code])
  @@index([isActive])
  @@index([isTestnet])
  @@index([deletedAt])
  @@map("networks")
}

model BaseCurrency {
  id              String         @id @default(cuid())
  code            String         @unique // "USDT", "BTC", "ETH"
  name            String         // "Tether USD", "Bitcoin", "Ethereum"
  symbol          String         // "USDT", "BTC", "ETH"
  imageUrl        String?
  coinGeckoId     String?
  coinMarketCapId String?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
  priority        Int            @default(0)
  currencies      Currency[]

  @@index([code])
  @@index([symbol])
  @@index([isActive])
  @@index([priority])
  @@index([deletedAt])
  @@map("base_currencies")
}

model Currency {
  id              String         @id @default(cuid())
  baseCurrencyId  String
  networkId       String
  contractAddress String?        // Token contract address (null for native coins)
  decimals        Int
  isToken         Boolean        @default(false)
  tokenStandard   String?        // "BEP-20", "TRC-20", "ERC-20"
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
  maxAmount       Decimal?       @db.Decimal(36, 18)
  minAmount       Decimal        @default(0) @db.Decimal(36, 18)
  withdrawFee     Decimal        @default(0) @db.Decimal(36, 18)
  baseCurrency    BaseCurrency   @relation(fields: [baseCurrencyId], references: [id])
  network         Network        @relation(fields: [networkId], references: [id])
  // wallets relation removed - using GlobalHDWallet system instead

  @@unique([baseCurrencyId, networkId]) // Same base currency can exist on multiple networks
  @@index([baseCurrencyId])
  @@index([networkId])
  @@index([contractAddress])
  @@index([isActive])
  @@index([deletedAt])
  @@map("currencies")
}

// Wallet model removed - replaced with HD wallet architecture:
// - GlobalHDWallet: Manages global wallets for all currencies/networks  
// - MerchantBalance: Tracks individual merchant balances per global wallet
// - DerivedAddress: Individual payment addresses derived from global wallets
// See HD_WALLET_MIGRATION_TRACKER.md for complete migration details

model Invoice {
  id                String            @id @default(cuid())
  amount            Decimal           @db.Decimal(36, 18)
  currency          String
  depositAddress    String            @unique
  description       String?
  status            InvoiceStatus     @default(PENDING)
  paidAt            DateTime?
  expiresAt         DateTime
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  merchantId        String
  addressId         String            // Address - primary reference
  amountPaid        Decimal           @default(0) @db.Decimal(36, 18)
  confirmedAt       DateTime?
  customData        Json?
  deletedAt         DateTime?
  exchangeRate      Decimal?          @db.Decimal(18, 8)
  fiatAmount        Decimal?          @db.Decimal(10, 2)
  fiatCurrency      String?
  memo              String?
  notifyUrl         String?
  orderId           String?
  qrCodeData        String?
  redirectUrl       String?
  returnUrl         String?
  merchant          Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  address           Address           @relation(fields: [addressId], references: [id])  // Primary relation
  transactions      Transaction[]
  webhookDeliveries WebhookDelivery[]
  webhookNotifications WebhookNotification[]

  @@index([merchantId])
  @@index([status])
  @@index([depositAddress])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([paidAt])
  @@index([orderId])
  @@index([deletedAt])
  @@map("invoices")
}

model Transaction {
  id             String            @id @default(cuid())
  txHash         String            @unique
  amount         Decimal           @db.Decimal(36, 18)
  blockNumber    BigInt?
  confirmations  Int               @default(0)
  status         TransactionStatus @default(PENDING)
  tatumWebhookId String?           @unique
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  invoiceId      String
  blockHash      String?
  deletedAt      DateTime?
  failureReason  String?
  fromAddress    String?
  gasPrice       BigInt?
  gasUsed        BigInt?
  processedAt    DateTime?
  toAddress      String?
  transactionFee Decimal?          @db.Decimal(36, 18)
  invoice        Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([txHash])
  @@index([invoiceId])
  @@index([status])
  @@index([blockNumber])
  @@index([createdAt])
  @@index([processedAt])
  @@index([deletedAt])
  @@map("transactions")
}

// AddressPool model removed - replaced with HD wallet architecture:
// - GlobalHDWallet: Manages global wallets for all currencies/networks
// - DerivedAddress: Individual payment addresses derived from global wallets
// - MerchantBalance: Tracks individual merchant balances
// Pre-generated address pools are no longer needed with HD wallet derivation

model WebhookDelivery {
  id             String           @id @default(cuid())
  url            String
  eventType      WebhookEventType
  status         WebhookStatus    @default(PENDING)
  payload        Json
  headers        Json?
  response       Json?
  httpStatus     Int?
  attemptCount   Int              @default(0)
  maxAttempts    Int              @default(3)
  nextRetryAt    DateTime?
  sentAt         DateTime?
  acknowledgedAt DateTime?
  errorMessage   String?
  timeoutSeconds Int              @default(30)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  merchantId     String
  invoiceId      String?
  invoice        Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  merchant       Merchant         @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([invoiceId])
  @@index([status])
  @@index([eventType])
  @@index([nextRetryAt])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("webhook_deliveries")
}

model MerchantSettings {
  id                   String   @id @default(cuid())
  webhookNotifications Boolean  @default(true)
  autoConfirmPayments  Boolean  @default(true)
  minimumConfirmations Int      @default(6)
  brandColor           String?
  logoUrl              String?
  companyName          String?
  supportEmail         String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  merchantId           String   @unique
  merchant             Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  // Removed unused fields: emailNotifications, smsNotifications, defaultInvoiceExpiry, allowPartialPayments, ipWhitelist, requireSignature, allowTestMode, businessType, businessCountry, taxRate

  @@map("merchant_settings")
}

model ApiUsageStats {
  id           String   @id @default(cuid())
  endpoint     String
  method       String
  requestCount Int      @default(1)
  responseTime Int?
  errorCount   Int      @default(0)
  hourlyBucket DateTime
  dailyBucket  DateTime
  userAgent    String?
  ipAddress    String?
  statusCode   Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  merchantId   String
  merchant     Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, endpoint, method, hourlyBucket])
  @@index([merchantId])
  @@index([hourlyBucket])
  @@index([dailyBucket])
  @@index([endpoint])
  @@map("api_usage_stats")
}

model UserSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  expires      DateTime
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastUsed     DateTime 
  userId       String?
  user         User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([sessionToken])
  @@index([userId])
  @@index([expires])
  @@index([isActive])
  @@map("user_sessions")
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  tableName  String?
  recordId   String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  endpoint   String?
  method     String?
  statusCode Int?
  createdAt  DateTime @default(now())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([tableName])
  @@index([recordId])
  @@index([createdAt])
  @@map("audit_logs")
}

// BalanceHistory model removed - was only used by deprecated TatumPaymentService
// Balance history is now tracked through MerchantBalance updates in the HD wallet system

// PriceHistory model removed - was intended for tracking cryptocurrency prices over time
// but was never implemented. Price data can be fetched from external APIs when needed

enum InvoiceStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED
  UNDERPAID
  OVERPAID
  PROCESSING
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  REJECTED
  REPLACED
}

enum WebhookStatus {
  PENDING
  SENT
  FAILED
  ACKNOWLEDGED
}

enum WebhookEventType {
  INVOICE_CREATED
  INVOICE_PAID
  INVOICE_EXPIRED
  INVOICE_CANCELLED
  TRANSACTION_CONFIRMED
  TRANSACTION_FAILED
}

// AddressStatus enum removed - was only used by the obsolete AddressPool model
// HD wallet system uses DerivedAddress with simpler tracking via assignedToInvoice field

enum NotificationType {
  EMAIL
  WEBHOOK
  SMS
}

enum UserRole {
  ADMIN
  MERCHANT
  OPERATOR
}

enum WalletStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  PENDING_SETUP
}

enum WalletType {
  MNEMONIC      // Wallet generated from mnemonic (can derive addresses)
  PRIVATE_KEY   // Single private key wallet
}

// Tatum KMS wallet system - replaces GlobalHDWallet
model Wallet {
  id                 String            @id @default(cuid())
  currency           String            // "BTC", "ETH", "USDT"
  network            String            // "bitcoin", "ethereum", "bsc", "tron"
  contractAddress    String?           // NULL for native, contract address for tokens
  
  // Tatum KMS specific fields
  signatureId        String            @unique // KMS signature ID for wallet/mnemonic
  walletType         WalletType        @default(MNEMONIC)
  xpub               String?           // Extended public key (if available from KMS)
  
  // Address management
  nextAddressIndex   BigInt            @default(0) // Counter for address derivation
  totalPoolBalance   Decimal           @default(0) @db.Decimal(36, 18) // Total balance
  
  status             WalletStatus      @default(PENDING_SETUP)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  // Relations
  merchantBalances   MerchantBalance[]
  addresses          Address[]

  @@unique([currency, network, contractAddress])
  @@index([status])
  @@index([currency])
  @@index([network])
  @@index([signatureId])
  @@map("wallets")
}

model MerchantBalance {
  id             String        @id @default(cuid())
  merchantId     String
  walletId       String        // References Wallet
  balance        Decimal       @default(0) @db.Decimal(36, 18)       // Available balance
  lockedBalance  Decimal       @default(0) @db.Decimal(36, 18)       // Locked for pending withdrawals
  totalReceived  Decimal       @default(0) @db.Decimal(36, 18)       // Lifetime received
  totalWithdrawn Decimal       @default(0) @db.Decimal(36, 18)       // Lifetime withdrawn
  lastUpdated    DateTime      @default(now())
  createdAt      DateTime      @default(now())

  // Relations
  merchant       Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  wallet         Wallet        @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([merchantId, walletId])
  @@index([merchantId])
  @@index([walletId])
  @@index([balance])
  @@map("merchant_balances")
}

// Address system for KMS wallets - replaces DerivedAddress
model Address {
  id                String         @id @default(cuid())
  walletId          String         // References Wallet
  merchantId        String
  address           String         @unique
  derivationIndex   BigInt         // Address derivation index
  
  // KMS signature ID for this specific address private key (if stored separately)
  signatureId       String?        @unique
  
  currentBalance    Decimal        @default(0) @db.Decimal(36, 18)
  assignedToInvoice String?        // NULL if not assigned, invoice ID if assigned
  firstUsedAt       DateTime?
  lastActivityAt    DateTime?
  createdAt         DateTime       @default(now())

  // Tatum notification tracking
  tatumSubscriptionId String?      // Tatum notification subscription ID
  subscriptionActive  Boolean      @default(false) // Whether monitoring is active
  lastNotificationAt  DateTime?    // Last webhook notification received

  // Relations
  wallet            Wallet         @relation(fields: [walletId], references: [id], onDelete: Cascade)
  merchant          Merchant       @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  invoices          Invoice[]
  webhookNotifications WebhookNotification[]

  @@index([walletId])
  @@index([merchantId])
  @@index([derivationIndex])
  @@index([assignedToInvoice])
  @@index([signatureId])
  @@index([tatumSubscriptionId])
  @@index([subscriptionActive])
  @@map("addresses")
}

model WebhookNotification {
  id                String        @id @default(cuid())
  addressId         String        // References Address
  invoiceId         String?       // Associated invoice if applicable
  txHash            String        @unique // Transaction hash from webhook
  amount            Decimal       @db.Decimal(36, 18)
  blockNumber       BigInt?
  confirmations     Int           @default(0)
  chain             String        // ETH, BTC, etc.
  status            String        @default("PENDING") // PENDING, CONFIRMED, FAILED
  webhookPayload    Json          // Raw webhook data for debugging
  processedAt       DateTime?     // When we processed this webhook
  createdAt         DateTime      @default(now())
  
  // Relations
  address           Address       @relation(fields: [addressId], references: [id], onDelete: Cascade)
  invoice           Invoice?      @relation(fields: [invoiceId], references: [id])

  @@index([addressId])
  @@index([invoiceId])
  @@index([txHash])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_notifications")
}

model Withdrawal {
  id                String   @id @default(cuid())
  merchantId        String
  currency          String   // "USDT", "BTC", "ETH"
  totalAmount       Decimal  @db.Decimal(36, 18)
  targetNetwork     String   // Target network for withdrawal
  targetAddress     String   // User's wallet address
  status            WithdrawalStatus @default(PENDING)
  withdrawalSources Json     // Array of {network: string, amount: number}
  totalFees         Decimal  @db.Decimal(36, 18)
  needsBridging     Boolean  @default(false)
  transactions      Json?    // Array of blockchain transaction hashes
  completedAt       DateTime?
  failedReason      String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  merchant          Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([status])
  @@index([createdAt])
  @@map("withdrawals")
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
