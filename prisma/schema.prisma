generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================

model User {
  id                     String        @id @default(cuid())
  email                  String        @unique
  name                   String
  password               String
  isActive               Boolean       @default(true)
  emailVerified          Boolean       @default(false)
  emailVerificationToken String?
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  lastLogin              DateTime?
  role                   UserRole      @default(MERCHANT)
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  deletedAt              DateTime?
  
  // Relations
  auditLogs              AuditLog[]
  merchants              Merchant[]
  sessions               UserSession[]

  @@index([email])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("users")
}

model UserSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  expires      DateTime
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  lastUsed     DateTime 
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String?
  
  // Relations
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([sessionToken])
  @@index([userId])
  @@index([expires])
  @@index([isActive])
  @@map("user_sessions")
}

// ============================================
// MERCHANT MANAGEMENT
// ============================================

model Merchant {
  id                String            @id @default(cuid())
  name              String
  businessName      String?
  businessAddress   String?
  taxId             String?
  apiKey            String            @unique
  apiKeyHash        String
  apiKeyCreatedAt   DateTime          @default(now())
  apiKeyLastUsed    DateTime?
  webhookUrl        String?
  isActive          Boolean           @default(true)
  userId            String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?
  
  // Relations
  user              User?             @relation(fields: [userId], references: [id])
  apiUsageStats     ApiUsageStats[]
  invoices          Invoice[]
  merchantSettings  MerchantSettings?
  webhookDeliveries WebhookDelivery[]
  merchantWallets   MerchantWallet[]  // Renamed from merchantBalances
  paymentAddresses  PaymentAddress[]  // Direct relation for merchant's addresses
  withdrawals       Withdrawal[]

  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([apiKeyLastUsed])
  @@index([userId])
  @@map("merchants")
}

model MerchantSettings {
  id                   String   @id @default(cuid())
  webhookNotifications Boolean  @default(true)
  autoConfirmPayments  Boolean  @default(true)
  minimumConfirmations Int      @default(6)
  brandColor           String?
  logoUrl              String?
  companyName          String?
  supportEmail         String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  merchantId           String   @unique
  
  // Relations
  merchant             Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@map("merchant_settings")
}

// ============================================
// UNIFIED WALLET & CURRENCY ARCHITECTURE
// ============================================

// Single definition for each cryptocurrency/token
model Asset {
  id              String         @id @default(cuid())
  symbol          String         @unique  // "BTC", "ETH", "USDT", "USDC"
  name            String                  // "Bitcoin", "Ethereum", "Tether USD"
  type            AssetType               // NATIVE or TOKEN
  logoUrl         String?
  decimals        Int            @default(18) // Default decimals
  coinGeckoId     String?
  coinMarketCapId String?
  isActive        Boolean        @default(true)
  priority        Int            @default(0) // For display ordering
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  assetNetworks   AssetNetwork[]

  @@index([symbol])
  @@index([isActive])
  @@index([priority])
  @@map("assets")
}

// Blockchain networks
model Network {
  id                 String         @id @default(cuid())
  code               String         @unique  // "ethereum", "bsc", "polygon", "bitcoin", "tron"
  name               String                   // "Ethereum Mainnet", "Binance Smart Chain"
  chainId            Int?                     // Numeric chain ID for EVM chains
  tatumChainId       String         @unique  // Tatum's chain identifier
  type               NetworkType              // EVM, UTXO, TRON
  isTestnet          Boolean        @default(false)
  blockConfirmations Int            @default(6)
  rpcUrl             String?
  explorerUrl        String?
  isActive           Boolean        @default(true)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  
  // Relations
  assetNetworks      AssetNetwork[]
  systemWallets      SystemWallet[]

  @@index([code])
  @@index([isActive])
  @@index([isTestnet])
  @@map("networks")
}

// Configuration for assets on specific networks
model AssetNetwork {
  id                String         @id @default(cuid())
  assetId           String
  networkId         String
  contractAddress   String?        // NULL for native coins, address for tokens
  decimals          Int            // Network-specific decimals
  tokenStandard     String?        // "ERC-20", "BEP-20", "TRC-20"
  minAmount         Decimal        @default(0) @db.Decimal(36, 18)
  maxAmount         Decimal?       @db.Decimal(36, 18)
  depositFee        Decimal        @default(0) @db.Decimal(36, 18)
  withdrawalFee     Decimal        @default(0) @db.Decimal(36, 18)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  // Relations
  asset             Asset          @relation(fields: [assetId], references: [id])
  network           Network        @relation(fields: [networkId], references: [id])
  systemWallets     SystemWallet[]

  @@unique([assetId, networkId])
  @@index([assetId])
  @@index([networkId])
  @@index([contractAddress])
  @@index([isActive])
  @@map("asset_networks")
}

// System-wide KMS-managed wallets
model SystemWallet {
  id                 String            @id @default(cuid())
  assetNetworkId     String
  networkId          String            // Direct reference for easier queries
  
  // KMS Integration
  signatureId        String            @unique  // KMS signature ID for wallet/mnemonic
  walletType         WalletType        @default(MNEMONIC)
  xpub               String?           // Extended public key from KMS
  derivationPath     String            @default("m/44'/60'/0'/0") // HD derivation path
  
  // Address Management
  nextAddressIndex   BigInt            @default(0)
  totalBalance       Decimal           @default(0) @db.Decimal(36, 18)
  
  // Status
  status             WalletStatus      @default(PENDING_SETUP)
  metadata           Json?             // Additional KMS data, configuration
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  
  // Relations
  assetNetwork       AssetNetwork      @relation(fields: [assetNetworkId], references: [id])
  network            Network           @relation(fields: [networkId], references: [id])
  merchantWallets    MerchantWallet[]
  paymentAddresses   PaymentAddress[]

  @@index([status])
  @@index([assetNetworkId])
  @@index([networkId])
  @@index([signatureId])
  @@map("system_wallets")
}

// Merchant-specific wallet balances and settings
model MerchantWallet {
  id                    String        @id @default(cuid())
  merchantId            String
  systemWalletId        String
  
  // Balances
  availableBalance      Decimal       @default(0) @db.Decimal(36, 18)  // Confirmed balance
  pendingBalance        Decimal       @default(0) @db.Decimal(36, 18)  // Unconfirmed
  lockedBalance         Decimal       @default(0) @db.Decimal(36, 18)  // Reserved for withdrawals
  
  // Statistics
  totalReceived         Decimal       @default(0) @db.Decimal(36, 18)
  totalWithdrawn        Decimal       @default(0) @db.Decimal(36, 18)
  
  // Auto-withdrawal settings
  autoWithdrawEnabled   Boolean       @default(false)
  autoWithdrawAddress   String?
  autoWithdrawThreshold Decimal?      @db.Decimal(36, 18)
  
  // Metadata
  lastActivityAt        DateTime?
  statistics            Json?         // Additional metrics
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  // Relations
  merchant              Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  systemWallet          SystemWallet  @relation(fields: [systemWalletId], references: [id])
  paymentAddresses      PaymentAddress[]

  @@unique([merchantId, systemWalletId])
  @@index([merchantId])
  @@index([systemWalletId])
  @@index([availableBalance])
  @@map("merchant_wallets")
}

// Individual payment addresses
model PaymentAddress {
  id                   String         @id @default(cuid())
  systemWalletId       String
  merchantWalletId     String
  merchantId           String         // Direct reference for easier queries
  
  // Address details
  address              String         @unique
  derivationIndex      BigInt
  addressSignatureId   String?        @unique  // KMS signature ID if stored separately
  
  // Assignment
  invoiceId            String?        @unique  // One address per invoice
  balance              Decimal        @default(0) @db.Decimal(36, 18)
  
  // Tatum monitoring
  tatumSubscriptionId  String?        @unique
  subscriptionActive   Boolean        @default(false)
  
  // Activity tracking
  firstSeenAt          DateTime?
  lastSeenAt           DateTime?
  metadata             Json?
  createdAt            DateTime       @default(now())
  
  // Relations
  systemWallet         SystemWallet   @relation(fields: [systemWalletId], references: [id])
  merchantWallet       MerchantWallet @relation(fields: [merchantWalletId], references: [id])
  merchant             Merchant       @relation(fields: [merchantId], references: [id])
  invoice              Invoice?
  webhookNotifications WebhookNotification[]

  @@index([systemWalletId])
  @@index([merchantWalletId])
  @@index([merchantId])
  @@index([derivationIndex])
  @@index([invoiceId])
  @@index([addressSignatureId])
  @@index([tatumSubscriptionId])
  @@index([subscriptionActive])
  @@map("payment_addresses")
}

// ============================================
// INVOICES & TRANSACTIONS
// ============================================

model Invoice {
  id                String            @id @default(cuid())
  merchantId        String
  paymentAddressId  String            @unique  // One-to-one with PaymentAddress
  
  // Payment details
  amount            Decimal           @db.Decimal(36, 18)
  currency          String            // Asset symbol
  network           String            // Network code
  depositAddress    String            // Denormalized for quick access
  
  // Status
  status            InvoiceStatus     @default(PENDING)
  amountPaid        Decimal           @default(0) @db.Decimal(36, 18)
  
  // Metadata
  orderId           String?
  description       String?
  customData        Json?
  memo              String?
  
  // URLs
  notifyUrl         String?
  redirectUrl       String?
  returnUrl         String?
  qrCodeData        String?
  
  // Exchange rates
  fiatAmount        Decimal?          @db.Decimal(10, 2)
  fiatCurrency      String?
  exchangeRate      Decimal?          @db.Decimal(18, 8)
  
  // Timestamps
  paidAt            DateTime?
  confirmedAt       DateTime?
  expiresAt         DateTime
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?
  
  // Relations
  merchant          Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  paymentAddress    PaymentAddress    @relation(fields: [paymentAddressId], references: [id])
  transactions      Transaction[]
  webhookDeliveries WebhookDelivery[]
  webhookNotifications WebhookNotification[]

  @@index([merchantId])
  @@index([status])
  @@index([depositAddress])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([paidAt])
  @@index([orderId])
  @@index([deletedAt])
  @@map("invoices")
}

model Transaction {
  id             String            @id @default(cuid())
  invoiceId      String
  
  // Transaction details
  txHash         String            @unique
  amount         Decimal           @db.Decimal(36, 18)
  fromAddress    String?
  toAddress      String?
  
  // Block information
  blockNumber    BigInt?
  blockHash      String?
  confirmations  Int               @default(0)
  
  // Status
  status         TransactionStatus @default(PENDING)
  failureReason  String?
  
  // Gas/Fees
  gasPrice       BigInt?
  gasUsed        BigInt?
  transactionFee Decimal?          @db.Decimal(36, 18)
  
  // Tatum
  tatumWebhookId String?           @unique
  
  // Timestamps
  processedAt    DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  deletedAt      DateTime?
  
  // Relations
  invoice        Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([txHash])
  @@index([invoiceId])
  @@index([status])
  @@index([blockNumber])
  @@index([createdAt])
  @@index([processedAt])
  @@index([deletedAt])
  @@map("transactions")
}

// ============================================
// WEBHOOKS & NOTIFICATIONS
// ============================================

model WebhookNotification {
  id                String        @id @default(cuid())
  paymentAddressId  String
  invoiceId         String?
  
  // Transaction details
  txHash            String        @unique
  amount            Decimal       @db.Decimal(36, 18)
  blockNumber       BigInt?
  confirmations     Int           @default(0)
  chain             String
  
  // Status
  status            String        @default("PENDING")
  webhookPayload    Json
  processedAt       DateTime?
  createdAt         DateTime      @default(now())
  
  // Relations
  paymentAddress    PaymentAddress @relation(fields: [paymentAddressId], references: [id], onDelete: Cascade)
  invoice           Invoice?       @relation(fields: [invoiceId], references: [id])

  @@index([paymentAddressId])
  @@index([invoiceId])
  @@index([txHash])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_notifications")
}

model WebhookDelivery {
  id             String           @id @default(cuid())
  merchantId     String
  invoiceId      String?
  
  // Delivery details
  url            String
  eventType      WebhookEventType
  status         WebhookStatus    @default(PENDING)
  
  // Payload & Response
  payload        Json
  headers        Json?
  response       Json?
  httpStatus     Int?
  errorMessage   String?
  
  // Retry logic
  attemptCount   Int              @default(0)
  maxAttempts    Int              @default(3)
  nextRetryAt    DateTime?
  timeoutSeconds Int              @default(30)
  
  // Timestamps
  sentAt         DateTime?
  acknowledgedAt DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  
  // Relations
  invoice        Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  merchant       Merchant         @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([invoiceId])
  @@index([status])
  @@index([eventType])
  @@index([nextRetryAt])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("webhook_deliveries")
}

// ============================================
// WITHDRAWALS
// ============================================

model Withdrawal {
  id                String           @id @default(cuid())
  merchantId        String
  
  // Withdrawal details
  asset             String           // Asset symbol
  totalAmount       Decimal          @db.Decimal(36, 18)
  targetNetwork     String           // Target network code
  targetAddress     String           // Destination address
  
  // Processing
  status            WithdrawalStatus @default(PENDING)
  withdrawalSources Json             // Array of {networkId, amount, systemWalletId}
  totalFees         Decimal          @db.Decimal(36, 18)
  needsBridging     Boolean          @default(false)
  
  // Results
  transactions      Json?            // Array of tx hashes
  failedReason      String?
  
  // Timestamps
  completedAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  merchant          Merchant         @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([status])
  @@index([createdAt])
  @@map("withdrawals")
}

// ============================================
// MONITORING & ANALYTICS
// ============================================

model ApiUsageStats {
  id           String   @id @default(cuid())
  merchantId   String
  
  // Request details
  endpoint     String
  method       String
  statusCode   Int?
  responseTime Int?
  
  // Metrics
  requestCount Int      @default(1)
  errorCount   Int      @default(0)
  
  // Grouping
  hourlyBucket DateTime
  dailyBucket  DateTime
  
  // Context
  userAgent    String?
  ipAddress    String?
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  merchant     Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, endpoint, method, hourlyBucket])
  @@index([merchantId])
  @@index([hourlyBucket])
  @@index([dailyBucket])
  @@index([endpoint])
  @@map("api_usage_stats")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  
  // Action details
  action     String
  tableName  String?
  recordId   String?
  
  // Changes
  oldValues  Json?
  newValues  Json?
  
  // Context
  ipAddress  String?
  userAgent  String?
  endpoint   String?
  method     String?
  statusCode Int?
  
  // Timestamp
  createdAt  DateTime @default(now())
  
  // Relations
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([tableName])
  @@index([recordId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MERCHANT
  OPERATOR
}

enum AssetType {
  NATIVE
  TOKEN
}

enum NetworkType {
  EVM
  UTXO
  TRON
  SOLANA
}

enum WalletType {
  MNEMONIC      // HD wallet from mnemonic
  PRIVATE_KEY   // Single private key
}

enum WalletStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  PENDING_SETUP
}

enum InvoiceStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED
  UNDERPAID
  OVERPAID
  PROCESSING
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  REJECTED
  REPLACED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum WebhookStatus {
  PENDING
  SENT
  FAILED
  ACKNOWLEDGED
}

enum WebhookEventType {
  INVOICE_CREATED
  INVOICE_PAID
  INVOICE_EXPIRED
  INVOICE_CANCELLED
  TRANSACTION_CONFIRMED
  TRANSACTION_FAILED
}
