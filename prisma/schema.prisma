generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String        @id @default(cuid())
  email                  String        @unique
  name                   String
  password               String
  isActive               Boolean       @default(true)
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt
  deletedAt              DateTime?
  emailVerificationToken String?
  emailVerified          Boolean       @default(false)
  lastLogin              DateTime?
  passwordResetExpires   DateTime?
  passwordResetToken     String?
  role                   UserRole      @default(MERCHANT)
  auditLogs              AuditLog[]
  merchants              Merchant[]
  sessions               UserSession[]

  @@index([email])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("users")
}

model Merchant {
  id                String            @id @default(cuid())
  name              String
  email             String            @unique
  apiKey            String            @unique
  apiKeyHash        String
  webhookUrl        String?
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  userId            String?
  apiKeyCreatedAt   DateTime          @default(now())
  apiKeyLastUsed    DateTime?
  businessAddress   String?
  businessName      String?
  defaultCurrency   String            @default("USD")
  deletedAt         DateTime?
  invoiceExpiry     Int               @default(3600)
  isVerified        Boolean           @default(false)
  rateLimit         Int               @default(100)
  rateLimitWindow   Int               @default(3600)
  taxId             String?
  webhookRetryCount Int               @default(3)
  webhookSecret     String?
  webhookTimeout    Int               @default(30)
  addressPools      AddressPool[]
  apiUsageStats     ApiUsageStats[]
  invoices          Invoice[]
  merchantSettings  MerchantSettings?
  user              User?             @relation(fields: [userId], references: [id])
  wallets           Wallet[]
  webhookDeliveries WebhookDelivery[]

  @@index([isActive])
  @@index([isVerified])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([apiKeyLastUsed])
  @@index([email])
  @@map("merchants")
}

model Network {
  id                 String        @id @default(cuid())
  code               String        @unique
  name               String
  tatumChainId       String        @unique
  blockConfirmations Int           @default(6)
  isTestnet          Boolean       @default(false)
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  averageBlockTime   Int?
  deletedAt          DateTime?
  explorerUrl        String?
  lastBlockChecked   BigInt?
  lastStatusCheck    DateTime      @default(now())
  maxWithdrawAmount  Decimal?      @db.Decimal(36, 18)
  minWithdrawAmount  Decimal?      @db.Decimal(36, 18)
  networkStatus      String        @default("healthy")
  rpcUrl             String?
  withdrawFee        Decimal       @default(0) @db.Decimal(36, 18)
  addressPools       AddressPool[]
  currencies         Currency[]

  @@index([code])
  @@index([isActive])
  @@index([isTestnet])
  @@index([networkStatus])
  @@index([deletedAt])
  @@map("networks")
}

model Currency {
  id              String         @id @default(cuid())
  code            String         @unique
  name            String
  symbol          String
  decimals        Int
  isToken         Boolean        @default(false)
  contractAddress String?
  imageUrl        String?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  networkId       String
  coinGeckoId     String?
  coinMarketCapId String?
  deletedAt       DateTime?
  maxAmount       Decimal?       @db.Decimal(36, 18)
  minAmount       Decimal        @default(0) @db.Decimal(36, 18)
  priority        Int            @default(0)
  tokenStandard   String?
  network         Network        @relation(fields: [networkId], references: [id])
  priceHistory    PriceHistory[]
  wallets         Wallet[]

  @@index([code])
  @@index([symbol])
  @@index([isActive])
  @@index([networkId])
  @@index([priority])
  @@index([deletedAt])
  @@map("currencies")
}

model Wallet {
  id                String           @id @default(cuid())
  tatumAccountId    String           @unique
  balance           Decimal          @default(0) @db.Decimal(36, 18)
  isActive          Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  merchantId        String
  currencyId        String
  autoWithdraw      Boolean          @default(false)
  deletedAt         DateTime?
  lastBalanceUpdate DateTime         @default(now())
  lockedBalance     Decimal          @default(0) @db.Decimal(36, 18)
  pendingBalance    Decimal          @default(0) @db.Decimal(36, 18)
  withdrawAddress   String?
  withdrawThreshold Decimal?         @db.Decimal(36, 18)
  balanceHistory    BalanceHistory[]
  invoices          Invoice[]
  currency          Currency         @relation(fields: [currencyId], references: [id])
  merchant          Merchant         @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, currencyId])
  @@index([merchantId])
  @@index([currencyId])
  @@index([isActive])
  @@index([balance])
  @@index([lastBalanceUpdate])
  @@index([deletedAt])
  @@map("wallets")
}

model Invoice {
  id                String            @id @default(cuid())
  amount            Decimal           @db.Decimal(36, 18)
  currency          String
  depositAddress    String            @unique
  description       String?
  status            InvoiceStatus     @default(PENDING)
  paidAt            DateTime?
  expiresAt         DateTime
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  merchantId        String
  walletId          String
  amountPaid        Decimal           @default(0) @db.Decimal(36, 18)
  confirmedAt       DateTime?
  customData        Json?
  deletedAt         DateTime?
  exchangeRate      Decimal?          @db.Decimal(18, 8)
  fiatAmount        Decimal?          @db.Decimal(10, 2)
  fiatCurrency      String?
  memo              String?
  notifyUrl         String?
  orderId           String?
  qrCodeData        String?
  redirectUrl       String?
  returnUrl         String?
  merchant          Merchant          @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  wallet            Wallet            @relation(fields: [walletId], references: [id])
  transactions      Transaction[]
  webhookDeliveries WebhookDelivery[]

  @@index([merchantId])
  @@index([status])
  @@index([depositAddress])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([paidAt])
  @@index([orderId])
  @@index([deletedAt])
  @@map("invoices")
}

model Transaction {
  id             String            @id @default(cuid())
  txHash         String            @unique
  amount         Decimal           @db.Decimal(36, 18)
  blockNumber    BigInt?
  confirmations  Int               @default(0)
  status         TransactionStatus @default(PENDING)
  tatumWebhookId String?           @unique
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  invoiceId      String
  blockHash      String?
  deletedAt      DateTime?
  failureReason  String?
  fromAddress    String?
  gasPrice       BigInt?
  gasUsed        BigInt?
  processedAt    DateTime?
  toAddress      String?
  transactionFee Decimal?          @db.Decimal(36, 18)
  invoice        Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([txHash])
  @@index([invoiceId])
  @@index([status])
  @@index([blockNumber])
  @@index([createdAt])
  @@index([processedAt])
  @@index([deletedAt])
  @@map("transactions")
}

model AddressPool {
  id               String        @id @default(cuid())
  address          String        @unique
  privateKey       String?
  derivationPath   String?
  addressIndex     Int?
  memo             String?
  status           AddressStatus @default(AVAILABLE)
  assignedAt       DateTime?
  usedAt           DateTime?
  lastUsedAt       DateTime?
  currentBalance   Decimal       @default(0) @db.Decimal(36, 18)
  totalReceived    Decimal       @default(0) @db.Decimal(36, 18)
  transactionCount Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?
  merchantId       String
  networkId        String
  merchant         Merchant      @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  network          Network       @relation(fields: [networkId], references: [id])

  @@index([address])
  @@index([merchantId])
  @@index([networkId])
  @@index([status])
  @@index([assignedAt])
  @@index([deletedAt])
  @@map("address_pools")
}

model WebhookDelivery {
  id             String           @id @default(cuid())
  url            String
  eventType      WebhookEventType
  status         WebhookStatus    @default(PENDING)
  payload        Json
  headers        Json?
  response       Json?
  httpStatus     Int?
  attemptCount   Int              @default(0)
  maxAttempts    Int              @default(3)
  nextRetryAt    DateTime?
  sentAt         DateTime?
  acknowledgedAt DateTime?
  errorMessage   String?
  timeoutSeconds Int              @default(30)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  merchantId     String
  invoiceId      String?
  invoice        Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  merchant       Merchant         @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@index([merchantId])
  @@index([invoiceId])
  @@index([status])
  @@index([eventType])
  @@index([nextRetryAt])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("webhook_deliveries")
}

model MerchantSettings {
  id                   String   @id @default(cuid())
  emailNotifications   Boolean  @default(true)
  webhookNotifications Boolean  @default(true)
  smsNotifications     Boolean  @default(false)
  defaultInvoiceExpiry Int      @default(3600)
  allowPartialPayments Boolean  @default(false)
  autoConfirmPayments  Boolean  @default(true)
  minimumConfirmations Int      @default(6)
  brandColor           String?
  logoUrl              String?
  companyName          String?
  supportEmail         String?
  ipWhitelist          String[]
  requireSignature     Boolean  @default(true)
  allowTestMode        Boolean  @default(false)
  businessType         String?
  businessCountry      String?
  taxRate              Decimal? @db.Decimal(5, 4)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  merchantId           String   @unique
  merchant             Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@map("merchant_settings")
}

model ApiUsageStats {
  id           String   @id @default(cuid())
  endpoint     String
  method       String
  requestCount Int      @default(1)
  responseTime Int?
  errorCount   Int      @default(0)
  hourlyBucket DateTime
  dailyBucket  DateTime
  userAgent    String?
  ipAddress    String?
  statusCode   Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  merchantId   String
  merchant     Merchant @relation(fields: [merchantId], references: [id], onDelete: Cascade)

  @@unique([merchantId, endpoint, method, hourlyBucket])
  @@index([merchantId])
  @@index([hourlyBucket])
  @@index([dailyBucket])
  @@index([endpoint])
  @@map("api_usage_stats")
}

model UserSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  expires      DateTime
  ipAddress    String?
  userAgent    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastUsed     DateTime 
  userId       String?
  user         User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([sessionToken])
  @@index([userId])
  @@index([expires])
  @@index([isActive])
  @@map("user_sessions")
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  tableName  String?
  recordId   String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  endpoint   String?
  method     String?
  statusCode Int?
  createdAt  DateTime @default(now())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([tableName])
  @@index([recordId])
  @@index([createdAt])
  @@map("audit_logs")
}

model BalanceHistory {
  id            String   @id @default(cuid())
  balanceBefore Decimal  @db.Decimal(36, 18)
  balanceAfter  Decimal  @db.Decimal(36, 18)
  amountChange  Decimal  @db.Decimal(36, 18)
  changeType    String
  description   String?
  reference     String?
  createdAt     DateTime @default(now())
  walletId      String
  wallet        Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([createdAt])
  @@index([changeType])
  @@map("balance_history")
}

model PriceHistory {
  id         String   @id @default(cuid())
  price      Decimal  @db.Decimal(18, 8)
  volume24h  Decimal? @db.Decimal(18, 8)
  timestamp  DateTime @default(now())
  source     String   @default("coingecko")
  createdAt  DateTime @default(now())
  currencyId String
  currency   Currency @relation(fields: [currencyId], references: [id], onDelete: Cascade)

  @@unique([currencyId, timestamp, source])
  @@index([currencyId])
  @@index([timestamp])
  @@index([source])
  @@map("price_history")
}

enum InvoiceStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED
  UNDERPAID
  OVERPAID
  PROCESSING
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  REJECTED
  REPLACED
}

enum WebhookStatus {
  PENDING
  SENT
  FAILED
  ACKNOWLEDGED
}

enum WebhookEventType {
  INVOICE_CREATED
  INVOICE_PAID
  INVOICE_EXPIRED
  INVOICE_CANCELLED
  TRANSACTION_CONFIRMED
  TRANSACTION_FAILED
}

enum AddressStatus {
  AVAILABLE
  ASSIGNED
  USED
  EXPIRED
}

enum NotificationType {
  EMAIL
  WEBHOOK
  SMS
}

enum UserRole {
  ADMIN
  MERCHANT
  OPERATOR
}
